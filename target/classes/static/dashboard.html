<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL | DIETA EXATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root { --neon: #00f2ff; --bg: #050505; --card: #0d0d0d; --green: #2ecc71; --gold: #ffac00; }
        body { background: var(--bg); color: white; font-family: 'Rajdhani'; margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { width: 250px; background: #000; border-right: 1px solid #222; padding: 30px 20px; display: flex; flex-direction: column; gap: 20px; }
        .logo { font-family: 'Orbitron'; color: var(--neon); font-size: 20px; text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px var(--neon); }
        .nav-link { color: #888; text-decoration: none; padding: 12px; border-radius: 5px; transition: 0.3s; font-family: 'Orbitron'; font-size: 13px; border-left: 3px solid transparent; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: #111; color: white; border-left-color: var(--neon); }
        .logout { margin-top: auto; color: #ff4444; cursor: pointer; }

        /* Main Content */
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .user-info h2 { margin: 0; font-family: 'Orbitron'; font-size: 24px; }
        .plan-badge { background: var(--neon); color: black; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; font-family: 'Orbitron'; }

        /* Grid de Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); border: 1px solid #222; padding: 25px; border-radius: 15px; position: relative; }
        .stat-card h4 { margin: 0; color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-family: 'Orbitron'; font-size: 28px; margin: 15px 0; color: white; }
        .stat-card.balance .value { color: var(--green); }

        /* Seção Dieta e Link */
        .content-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .diet-box { flex: 2; min-width: 300px; background: var(--card); border: 1px solid #222; padding: 30px; border-radius: 15px; }
        .affiliate-box { flex: 1; min-width: 300px; background: linear-gradient(145deg, #0d0d0d, #1a1a1a); border: 1px solid var(--neon); padding: 30px; border-radius: 15px; }

        .btn-action { background: var(--neon); color: black; border: none; padding: 12px 20px; border-radius: 5px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; }
        .copy-link { background: #111; padding: 10px; border: 1px dashed #444; border-radius: 5px; font-size: 12px; word-break: break-all; margin: 10px 0; cursor: pointer; }

        .transfer-input { background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .transfer-input:focus { border-color: var(--neon); outline: none; }

        /* Tabelas de Rede e Financeiro (O que estava faltando) */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .data-table th { color: var(--neon); text-align: left; padding: 10px; border-bottom: 1px solid #222; font-family: 'Orbitron'; font-size: 11px; }
        .data-table td { padding: 10px; border-bottom: 1px solid #111; }

        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #222; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">DIETA EXATA</div>
        <a onclick="showSection('main-dash')" class="nav-link active" id="btn-dash">DASHBOARD</a>
        <a href="configurar-dieta.html" class="nav-link">MINHA DIETA</a>
        <a onclick="showSection('rede-section')" class="nav-link" id="btn-rede">MINHA REDE</a>
        <a onclick="showSection('financeiro-section')" class="nav-link" id="btn-fin">FINANCEIRO</a>
        <a href="upgrade.html" class="nav-link" style="color: var(--gold);">UPGRADE OURO</a>
        <div class="nav-link logout" onclick="logout()">SAIR DO TERMINAL</div>
    </aside>

    <main class="main" id="main-dash">
        <header class="header">
            <div class="user-info">
                <h2 id="user-name">Carregando...</h2>
                <span id="user-plan" class="plan-badge">ATIVANDO...</span>
            </div>
            <div id="system-status" style="font-size: 12px; color: var(--green);">SISTEMA ONLINE</div>
        </header>

        <div class="stats-grid">
            <div class="stat-card balance">
                <h4>Saldo Disponível</h4>
                <div class="value" id="balance">R$ 0,00</div>
                <small style="color: #666;">Próximo saque: R$ 50,00 min.</small>
            </div>
            <div class="stat-card">
                <h4>Rede Direta</h4>
                <div class="value" id="referrals">0</div>
                <small style="color: #666;">Membros ativos no Nível 1</small>
            </div>
            <div class="stat-card">
                <h4>Ganhos Totais</h4>
                <div class="value" id="total-earnings">R$ 0,00</div>
            </div>
        </div>

        <div class="content-flex section-toggle" id="content-main">
            <div class="diet-box">
                <h3 style="font-family: 'Orbitron'; margin-top: 0;">PROTOCOLO ATUAL</h3>
                <div id="diet-status">
                    <p style="color: #888;">Nenhuma dieta ativa no momento. Inicie a análise por I.A. para gerar seu protocolo de nutrição.</p>
                    <button class="btn-action" onclick="location.href='configurar-dieta.html'">GERAR MINHA DIETA</button>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #222; margin: 30px 0;">
                
                <h3 style="font-family: 'Orbitron'; color: var(--neon); font-size: 16px;">TRANSFERÊNCIA DE SALDO</h3>
                <p style="font-size: 12px; color: #888;">Envie fundos instantaneamente para outro membro da rede.</p>
                <input type="email" id="transf-email" class="transfer-input" placeholder="E-mail do destinatário">
                <input type="number" id="transf-valor" class="transfer-input" placeholder="Valor (R$)">
                <button class="btn-action" style="background: #1a1a1a; color: var(--neon); border: 1px solid var(--neon);" onclick="executarTransferencia()">EFETUAR TRANSFERÊNCIA</button>
                
                <button class="btn-action" style="background: #27ae60; color: white; margin-top: 10px;" onclick="window.open('https://wa.me/SEUNUMERO')">FALAR COM NUTRI</button>
            </div>

            <div class="affiliate-box">
                <h3 style="font-family: 'Orbitron'; margin-top: 0; color: var(--neon);">LINK DE AFILIADO</h3>
                <p style="font-size: 14px; color: #ccc;">Compartilhe seu link e ganhe comissões sobre cada upgrade na sua rede.</p>
                <div class="copy-link" id="affiliate-link" onclick="copyLink()">Carregando link...</div>
                <small style="color: #666;">Clique no box acima para copiar</small>
            </div>
        </div>

        <div id="rede-section" class="diet-box section-toggle" style="display: none; margin-top: 20px;">
            <h3 style="font-family: 'Orbitron'; color: var(--neon);">MINHA REDE (NÍVEL 1)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>NOME</th>
                        <th>PLANO</th>
                        <th>STATUS</th>
                    </tr>
                </thead>
                <tbody id="rede-lista"></tbody>
            </table>
        </div>

        <div id="financeiro-section" class="diet-box section-toggle" style="display: none; margin-top: 20px;">
            <h3 style="font-family: 'Orbitron'; color: var(--neon);">DETALHAMENTO FINANCEIRO</h3>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <div><small>Ganhos Diretos:</small><br><b id="ganho-dir" style="color: var(--green);">R$ 0,00</b></div>
                <div><small>Ganhos de Rede:</small><br><b id="ganho-ind" style="color: var(--gold);">R$ 0,00</b></div>
            </div>
            <p style="font-size: 12px; color: #888;">As comissões são pagas instantaneamente após a aprovação do PIX pela sua rede.</p>
        </div>
    </main>

    <script>
        const sessao = localStorage.getItem('usuarioLogado');
        if (!sessao) window.location.href = 'index.html';
        const user = JSON.parse(sessao);

        // Função para alternar visualização sem sair da página
        function showSection(sectionId) {
            document.querySelectorAll('.section-toggle').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            if (sectionId === 'main-dash') {
                document.getElementById('content-main').style.display = 'flex';
                document.getElementById('btn-dash').classList.add('active');
            } else {
                document.getElementById(sectionId).style.display = 'block';
                if(sectionId === 'rede-section') document.getElementById('btn-rede').classList.add('active');
                if(sectionId === 'financeiro-section') document.getElementById('btn-fin').classList.add('active');
            }
        }

        async function loadDashboardData() {
            try {
                const res = await fetch('api_bridge.php?path=api/usuarios/todos');
                const users = await res.json();
                const currentUser = users.find(u => u.email.toLowerCase() === user.email.toLowerCase());

                if (currentUser) {
                    document.getElementById('user-name').innerText = `OLÁ, ${currentUser.nome.split(' ')[0].toUpperCase()}`;
                    document.getElementById('user-plan').innerText = currentUser.plano || "BRONZE";
                    document.getElementById('balance').innerText = `R$ ${parseFloat(currentUser.saldoDisponivel || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    
                    const ganhosTotais = (currentUser.ganhosDiretos || 0) + (currentUser.ganhosIndiretos || 0);
                    document.getElementById('total-earnings').innerText = `R$ ${ganhosTotais.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    
                    // Financeiro Detalhado
                    document.getElementById('ganho-dir').innerText = `R$ ${parseFloat(currentUser.ganhosDiretos || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('ganho-ind').innerText = `R$ ${parseFloat(currentUser.ganhosIndiretos || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                    // Rede e Tabela
                    const indicados = users.filter(u => u.indicadoPor && u.indicadoPor.toLowerCase() === currentUser.email.toLowerCase());
                    document.getElementById('referrals').innerText = indicados.length;
                    
                    let listaHtml = "";
                    indicados.forEach(i => {
                        listaHtml += `<tr><td>${i.nome}</td><td>${i.plano}</td><td style="color:var(--green)">ATIVO</td></tr>`;
                    });
                    document.getElementById('rede-lista').innerHTML = listaHtml || "<tr><td colspan='3'>Nenhum indicado direto.</td></tr>";

                    const link = `${window.location.origin}/cadastro.html?ref=${encodeURIComponent(currentUser.email)}`;
                    document.getElementById('affiliate-link').innerText = link;

                    if (currentUser.dietaAtual) {
                        document.getElementById('diet-status').innerHTML = `
                            <p style="color: var(--green);">● Protocolo de Biohacking Ativo</p>
                            <button class="btn-action" onclick="location.href='configurar-dieta.html'">VER PROTOCOLO</button>
                        `;
                    }
                    localStorage.setItem('usuarioLogado', JSON.stringify(currentUser));
                }
            } catch (err) { console.error("Erro:", err); }
        }

        // ... (Funções de Transferência e Copiar Link permanecem as mesmas que você já tem)
        async function executarTransferencia() {
            const emailDest = document.getElementById('transf-email').value.trim();
            const valor = parseFloat(document.getElementById('transf-valor').value);
            const remetente = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!emailDest || isNaN(valor) || valor <= 0) return alert("Preencha os dados corretamente.");
            if (valor > remetente.saldoDisponivel) return alert("Saldo insuficiente.");

            try {
                const res = await fetch('api_bridge.php?path=api/usuarios/transferir', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ emailOrigem: remetente.email, emailDestino: emailDest, valor: valor })
                });
                if (res.ok) { alert("Transferência realizada!"); loadDashboardData(); }
                else { alert("Falha na transferência."); }
            } catch (err) { alert("Erro de conexão."); }
        }

        function copyLink() {
            const link = document.getElementById('affiliate-link').innerText;
            navigator.clipboard.writeText(link).then(() => {
                alert("Link copiado!");
            });
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        window.onload = loadDashboardData;
    </script>
</body>
</html>