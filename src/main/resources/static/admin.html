<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL | DIETA EXATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root { 
            --neon: #00f2ff; 
            --bg: #050505; 
            --card: #0d0d0d; 
            --green: #2ecc71; 
            --gold: #ffac00; 
            --text-dim: #888;
        }
        
        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* Sidebar */
        .sidebar { 
            width: 260px; 
            background: #000; 
            border-right: 1px solid #1a1a1a; 
            padding: 40px 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .logo { 
            font-weight: 800; 
            color: var(--neon); 
            font-size: 18px; 
            text-align: center; 
            margin-bottom: 40px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .nav-link { 
            color: var(--text-dim); 
            text-decoration: none; 
            padding: 14px 18px; 
            border-radius: 12px; 
            transition: 0.3s; 
            font-size: 13px; 
            font-weight: 600;
            cursor: pointer; 
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover, .nav-link.active { 
            background: #111; 
            color: white; 
            box-shadow: inset 4px 0 0 var(--neon);
        }
        
        .logout { 
            margin-top: auto; 
            color: #ff4444; 
            padding-top: 20px;
            border-top: 1px solid #1a1a1a;
            border-radius: 0;
        }

        /* Main Content */
        .main { flex: 1; padding: 40px; overflow-y: auto; background: #080808; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 40px; 
        }
        
        .user-info h2 { 
            margin: 0; 
            font-size: 22px; 
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .plan-badge { 
            background: rgba(0, 242, 255, 0.1); 
            color: var(--neon); 
            padding: 6px 14px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 700; 
            border: 1px solid rgba(0, 242, 255, 0.3);
            display: inline-block;
            margin-top: 8px;
        }

        /* Grid de Cards */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: var(--card); 
            border: 1px solid #1a1a1a; 
            padding: 24px; 
            border-radius: 20px; 
            transition: 0.3s;
        }
        
        .stat-card h4 { 
            margin: 0; 
            color: var(--text-dim); 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            font-weight: 700;
        }
        
        .stat-card .value { 
            font-size: 28px; 
            font-weight: 700; 
            margin: 16px 0 8px 0; 
            color: white; 
        }
        
        .stat-card.balance .value { color: var(--green); }

        .btn-withdraw {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
            transition: 0.3s;
        }
        .btn-withdraw:hover { background: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }

        /* Modal de Saque */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--neon);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .transfer-input { 
            background: #000; 
            border: 1px solid #222; 
            color: white; 
            padding: 14px; 
            border-radius: 10px; 
            margin-bottom: 12px; 
            width: 100%; 
            box-sizing: border-box; 
            font-family: 'Inter';
        }

        .btn-action { 
            background: var(--neon); 
            color: black; 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 15px; 
            font-size: 13px;
            transition: 0.3s;
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">DIETA EXATA</div>
        <a onclick="showSection('main-dash')" class="nav-link active" id="btn-dash">PAINEL</a>
        <a href="configurar-dieta.html" class="nav-link">MINHA DIETA</a>
        <a onclick="showSection('rede-section')" class="nav-link" id="btn-rede">MINHA REDE</a>
        
        <div id="admin-menu" style="display: none; border-top: 1px solid #222; margin-top: 10px; padding-top: 10px;">
            <p style="font-size: 10px; color: var(--neon); font-weight: 800; margin-left: 18px; margin-bottom: 10px;">GERENCIAMENTO</p>
            <a onclick="showSection('admin-withdraws')" class="nav-link" id="btn-adm-saques">PAGAR SAQUES</a>
        </div>

        <div class="nav-link logout" onclick="logout()">SAIR DO TERMINAL</div>
    </aside>

    <main class="main">
        <header class="header">
            <div class="user-info">
                <h2 id="user-name">CARREGANDO...</h2>
                <span id="user-plan" class="plan-badge">ATIVANDO...</span>
            </div>
        </header>

        <div id="main-dash">
            <div class="stats-grid">
                <div class="stat-card balance">
                    <h4>Saldo Disponível</h4>
                    <div class="value" id="balance">R$ 0,00</div>
                    <button class="btn-withdraw" onclick="abrirModalSaque()">SOLICITAR SAQUE PIX</button>
                </div>
                <div class="stat-card">
                    <h4>Ganhos Totais</h4>
                    <div class="value" id="total-earnings">R$ 0,00</div>
                </div>
            </div>
        </div>

        <div id="admin-withdraws" style="display: none;">
            <h3 style="color: var(--neon);">SAQUES PENDENTES</h3>
            <div id="lista-saques-admin"></div>
        </div>
    </main>

    <div id="modalSaque" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--neon);">RETIRADA PIX</h3>
            <input type="number" id="saque-valor" class="transfer-input" placeholder="Valor do saque (R$)">
            <input type="text" id="saque-chave" class="transfer-input" placeholder="Chave PIX">
            <button class="btn-action" onclick="confirmarSaque()">CONFIRMAR E ABATER SALDO</button>
            <button class="btn-action" style="background: #222; color: #888;" onclick="fecharModalSaque()">CANCELAR</button>
        </div>
    </div>

    <script>
        // --- LÓGICA DE DADOS E MMN ---
        let users = JSON.parse(localStorage.getItem('usuarios')) || [];
        let currentUserEmail = localStorage.getItem('usuarioLogado');
        let userIndex = users.findIndex(u => u.email === currentUserEmail);
        let user = users[userIndex];

        function carregarDados() {
            if (!user) return;
            document.getElementById('user-name').innerText = user.nome.toUpperCase();
            document.getElementById('user-plan').innerText = user.plano || 'FREE';
            
            // Exibe Saldo Disponível e Ganho Histórico
            document.getElementById('balance').innerText = `R$ ${parseFloat(user.balance || 0).toFixed(2)}`;
            document.getElementById('total-earnings').innerText = `R$ ${parseFloat(user.totalEarnings || 0).toFixed(2)}`;

            if (user.isAdmin) {
                document.getElementById('admin-menu').style.display = 'block';
                carregarSaquesAdmin();
            }
        }

        // --- FUNÇÕES DE SAQUE (CORREÇÃO DO SALDO) ---

        function abrirModalSaque() {
            document.getElementById('modalSaque').style.display = 'flex';
        }

        function fecharModalSaque() {
            document.getElementById('modalSaque').style.display = 'none';
        }

        function confirmarSaque() {
            const valorInput = document.getElementById('saque-valor').value;
            const valorSaque = parseFloat(valorInput);
            const chavePix = document.getElementById('saque-chave').value;

            if (isNaN(valorSaque) || valorSaque < 50) {
                alert("O valor mínimo para saque é R$ 50,00");
                return;
            }

            if (valorSaque > user.balance) {
                alert("Saldo insuficiente para esta retirada.");
                return;
            }

            if (!chavePix) {
                alert("Informe a chave PIX.");
                return;
            }

            // 1. ABATER NO BANCO DE DADOS (localStorage)
            // Mantemos o totalEarnings (histórico) e diminuímos o balance (disponível)
            user.balance -= valorSaque;
            
            // 2. REGISTRAR SOLICITAÇÃO DE SAQUE
            let saques = JSON.parse(localStorage.getItem('saques_pendentes')) || [];
            saques.push({
                email: user.email,
                nome: user.nome,
                valor: valorSaque,
                chavePix: chavePix,
                data: new Date().toLocaleString(),
                status: 'pendente'
            });

            // 3. SALVAR TUDO
            users[userIndex] = user;
            localStorage.setItem('usuarios', JSON.stringify(users));
            localStorage.setItem('saques_pendentes', JSON.stringify(saques));

            alert("Saque solicitado com sucesso! O valor foi deduzido do seu saldo disponível.");
            fecharModalSaque();
            carregarDados(); // Atualiza a tela na hora
        }

        // --- LÓGICA DE ADMIN PARA PAGAR ---
        function carregarSaquesAdmin() {
            let saques = JSON.parse(localStorage.getItem('saques_pendentes')) || [];
            let container = document.getElementById('lista-saques-admin');
            container.innerHTML = '';

            saques.forEach((s, index) => {
                if(s.status === 'pendente') {
                    container.innerHTML += `
                        <div style="background:#111; padding:15px; margin-bottom:10px; border-radius:10px;">
                            <p>Usuário: ${s.nome} (${s.email})</p>
                            <p>Valor: R$ ${s.valor.toFixed(2)}</p>
                            <p>Chave: ${s.chavePix}</p>
                            <button onclick="marcarComoPago(${index})" style="background:var(--green); border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">MARCAR COMO PAGO</button>
                        </div>
                    `;
                }
            });
        }

        function marcarComoPago(index) {
            let saques = JSON.parse(localStorage.getItem('saques_pendentes')) || [];
            saques[index].status = 'pago';
            localStorage.setItem('saques_pendentes', JSON.stringify(saques));
            alert("Status atualizado!");
            carregarSaquesAdmin();
        }

        function showSection(id) {
            document.querySelectorAll('.section-toggle, [id^="main-dash"], [id^="rede-section"], [id^="admin-"]').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('usuarioLogado');
            window.location.href = 'index.html';
        }

        window.onload = carregarDados;
    </script>
</body>
</html>