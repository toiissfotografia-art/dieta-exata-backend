<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONFIGURAR DIETA | DIETA EXATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root { --neon: #00f2ff; --bg: #050505; --card: #0d0d0d; --green: #00ff88; }
        body { background: var(--bg); color: white; font-family: 'Rajdhani'; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box;}
        
        .container { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid #222; width: 100%; max-width: 600px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.05); }
        
        h2 { font-family: 'Orbitron'; color: var(--neon); text-align: center; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .full-width { grid-column: span 2; }

        label { display: block; margin-bottom: 8px; font-size: 12px; color: #555; font-family: 'Orbitron'; text-transform: uppercase; }
        
        input, select { 
            width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: white; 
            border-radius: 8px; font-family: 'Rajdhani'; font-size: 16px; outline: none; box-sizing: border-box; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }

        .btn-salvar { 
            background: var(--neon); color: #000; border: none; padding: 18px; border-radius: 8px; 
            font-family: 'Orbitron'; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; 
            transition: 0.3s; text-transform: uppercase;
        }
        .btn-salvar:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--neon); }

        .btn-back { background: transparent; color: #555; border: none; cursor: pointer; font-family: 'Orbitron'; font-size: 10px; margin-bottom: 20px; display: block; text-decoration: none; }
        .btn-back:hover { color: var(--neon); }

        #resultado-dieta { margin-top: 30px; padding: 20px; background: #000; border: 1px dashed var(--green); border-radius: 10px; display: none; }
        #resultado-dieta h3 { font-family: 'Orbitron'; color: var(--green); font-size: 14px; margin-top: 0; }
        #dieta-texto { font-size: 14px; line-height: 1.6; white-space: pre-wrap; color: #ccc; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <a href="dashboard.html" class="btn-back">← VOLTAR AO PAINEL</a>
        <h2>MINHA <span style="color:#fff">DIETA EXATA</span></h2>
        
        <form id="formDieta">
            <div class="grid-form">
                <div class="form-group">
                    <label>Idade</label>
                    <input type="number" id="idade" placeholder="Ex: 25" required>
                </div>
                <div class="form-group">
                    <label>Sexo</label>
                    <select id="sexo">
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Peso (kg)</label>
                    <input type="number" step="0.1" id="peso" placeholder="Ex: 80.5" required>
                </div>
                <div class="form-group">
                    <label>Altura (cm)</label>
                    <input type="number" id="altura" placeholder="Ex: 175" required>
                </div>
                <div class="form-group full-width">
                    <label>Objetivo</label>
                    <select id="objetivo">
                        <option value="Perda de Peso">Perder Peso / Definição</option>
                        <option value="Ganho de Massa">Ganhar Massa Muscular</option>
                        <option value="Manutenção">Manter Peso Saudável</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Nível de Atividade</label>
                    <select id="atividade">
                        <option value="sedentario">Sedentário (Pouco exercício)</option>
                        <option value="moderado">Moderado (3-5x na semana)</option>
                        <option value="intenso">Intenso (Atleta / Diário)</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn-salvar" id="btnAcao">GERAR E SALVAR MINHA DIETA</button>
        </form>

        <div id="resultado-dieta">
            <h3>PLANO ALIMENTAR GERADO:</h3>
            <div id="dieta-texto"></div>
            <button class="btn-salvar" style="background: var(--green);" onclick="window.location.href='dashboard.html'">FINALIZAR E IR AO PAINEL</button>
        </div>
    </div>

    <script>
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        const emailUser = usuarioLogado ? usuarioLogado.email : null;

        if(!emailUser) {
            window.location.href = 'index.html';
        }

        document.getElementById('formDieta').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnAcao');
            btn.innerText = "PROCESSANDO BIOHACKING...";
            btn.disabled = true;

            const peso = parseFloat(document.getElementById('peso').value);
            const objetivo = document.getElementById('objetivo').value;
            const agua = Math.round(peso * 35);

            // Gerador de Texto (Biohacking)
            let dietaGerada = `### PLANO BIOHACKING - DIETA EXATA ###\n`;
            dietaGerada += `Objetivo: ${objetivo.toUpperCase()}\n`;
            dietaGerada += `Hidratação: ${agua}ml por dia.\n\n`;
            dietaGerada += `MANHÃ: 03 Ovos Cozidos + 1 Fruta.\n`;
            dietaGerada += `ALMOÇO: 150g Proteína + Vegetais Verdes à vontade.\n`;
            dietaGerada += `LANCHE: 30g de Castanhas ou Nozes.\n`;
            dietaGerada += `JANTAR: Sopa de Legumes com Frango ou Peixe.\n`;
            dietaGerada += `\nESTRATÉGIA: Evite açúcares e farinhas brancas.`;

            try {
                // --- INCLUSÃO: AJUSTE PARA PASSAR PELA PONTE PHP ---
                // Mudamos a chamada para usar a api_bridge.php e o path correto
                const res = await fetch(`api_bridge.php?path=api/usuarios/atualizar-dieta`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: emailUser,
                        dietaAtual: dietaGerada
                    })
                });
                // --- FIM DA INCLUSÃO ---

                if (res.ok) {
                    // Atualiza o localstorage para o dashboard ler sem precisar deslogar
                    usuarioLogado.dietaAtual = dietaGerada;
                    localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));

                    document.getElementById('formDieta').style.display = 'none';
                    document.getElementById('resultado-dieta').style.display = 'block';
                    document.getElementById('dieta-texto').innerText = dietaGerada;
                } else {
                    const erroTxt = await res.text();
                    alert("Erro ao salvar: " + (erroTxt || "Verifique sua conexão."));
                    btn.disabled = false;
                    btn.innerText = "TENTAR NOVAMENTE";
                }
            } catch (err) {
                console.error(err);
                alert("Servidor Offline ou Erro de Rede na Ponte PHP.");
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
            }
        };
    </script>
</body>
</html>