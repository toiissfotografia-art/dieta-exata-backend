<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ativação Dieta Exata</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        :root { --primary: #00f2ff; --success: #00ff88; --bg: #0a0a0a; --card: #161616; --text: #ffffff; --border: #262626; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 420px; padding: 20px; }
        .step-content { background: var(--card); padding: 30px; border-radius: 24px; border: 1px solid var(--border); display: none; animation: fadeIn 0.3s ease; text-align: center; }
        .step-content.active { display: block; }
        h1 { font-size: 22px; margin-bottom: 10px; color: var(--primary); }
        .subtitle { font-size: 14px; color: #aaa; margin-bottom: 25px; line-height: 1.5; }
        .plan-option { background: #212121; border: 2px solid transparent; padding: 15px; border-radius: 16px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; text-align: left; }
        .plan-option.selected { border-color: var(--primary); background: rgba(0, 242, 255, 0.05); }
        .plan-info { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 5px; }
        .plan-bonus { font-size: 12px; color: var(--success); font-weight: 500; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: #000; }
        .qr-wrapper { background: #fff; padding: 10px; border-radius: 16px; width: 200px; height: 200px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
        #qr-code-img { width: 100%; height: 100%; display: none; }
        .pix-box { background: #000; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 10px; color: #888; word-break: break-all; border: 1px dashed #444; margin-bottom: 10px; }
        .loader { border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="step1" class="step-content active">
        <h1>Ative sua Conta</h1>
        <p class="subtitle">Selecione seu plano. O sistema no Render pode levar 30 segundos para processar o primeiro pedido.</p>
        
        <div class="plan-option" onclick="selectPlan('BRONZE', 19.99, this)">
            <div class="plan-info"><span>Plano Bronze</span><span>R$ 19,99</span></div>
            <div class="plan-bonus">Bonus MMN: R$ 5,00 por indicação</div>
        </div>
        <div class="plan-option" onclick="selectPlan('PRATA', 49.99, this)">
            <div class="plan-info"><span>Plano Prata</span><span>R$ 49,99</span></div>
            <div class="plan-bonus">Bonus MMN: R$ 15,00 por indicação</div>
        </div>
        <div class="plan-option selected" onclick="selectPlan('OURO', 79.99, this)">
            <div class="plan-info"><span>Plano Ouro</span><span>R$ 79,99</span></div>
            <div class="plan-bonus">Bonus MMN: R$ 30,00 por indicação</div>
        </div>

        <button class="btn btn-primary" id="btn-gerar" onclick="gerarPagamento()">Gerar QR Code PIX</button>
        
        <div id="loading-area" style="display:none;">
            <div class="loader"></div>
            <p id="loading-text" style="font-size:12px; color:var(--primary); font-weight: bold;">LIGANDO SERVIDOR RENDER... (AGUARDE)</p>
        </div>
    </div>

    <div id="step2" class="step-content">
        <h1>Pagamento PIX</h1>
        <p class="subtitle">Escaneie o QR Code. Sua ativação será detectada automaticamente.</p>
        <div class="qr-wrapper"><img id="qr-code-img" src="" alt="QR PIX"></div>
        <div class="pix-box" id="payload-pix">Gerando código...</div>
        <button class="btn btn-primary" onclick="copiarCodigo()">Copiar Código PIX</button>
        <p style="font-size: 11px; color: var(--success); margin-top: 15px; font-weight: 600;">MONITORANDO PAGAMENTO...</p>
    </div>

    <div id="step3" class="step-content">
        <div style="font-size: 40px; margin-bottom: 15px;">✅</div>
        <h1>Pagamento Confirmado!</h1>
        <p class="subtitle">Detectamos sua transação de <strong id="plano-confirmado">...</strong> no sistema.</p>
        <p class="subtitle">Sua conta foi ativada. Seu painel MMN está sendo liberado.</p>
        <div class="loader"></div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    // MUDANÇA: Iniciei como OURO para bater com o seu relato de uso
    let selectedPlan = { nome: 'OURO', valor: 79.99 }; 

    if (!email) { 
        alert("Sessão expirada."); 
        window.location.href = "cadastro.html"; 
    }

    function selectPlan(nome, valor, el) {
        selectedPlan = { nome, valor };
        document.querySelectorAll('.plan-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
    }

    async function gerarPagamento() {
        const btn = document.getElementById('btn-gerar');
        const loader = document.getElementById('loading-area');
        btn.style.display = 'none';
        loader.style.display = 'block';

        try {
            const res = await fetch(`${CONFIG.BASE_URL}/api/pagamentos/pix`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plano: selectedPlan.nome, email: email })
            });

            if (!res.ok) throw new Error("Servidor iniciando");

            const data = await res.json();
            document.getElementById('payload-pix').innerText = data.pixCopiaEcola;
            let base64 = data.qrCodeBase64;
            document.getElementById('qr-code-img').src = base64.startsWith('data:') ? base64 : `data:image/png;base64,${base64}`;
            document.getElementById('qr-code-img').style.display = 'block';
            
            showStep(2);
            iniciarMonitoramento();
        } catch (e) {
            console.log("Tentando reconectar ao Render...");
            setTimeout(gerarPagamento, 4000); 
        }
    }

    function showStep(n) {
        document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
    }

    function copiarCodigo() {
        navigator.clipboard.writeText(document.getElementById('payload-pix').innerText);
        alert("Código Copiado!");
    }

    // --- CORREÇÃO DA LÓGICA DE MMN E ATIVAÇÃO DE PLANO ---
    function iniciarMonitoramento() {
        const checkInterval = setInterval(async () => {
            try {
                const res = await fetch(`${CONFIG.BASE_URL}/api/usuarios/todos`);
                const users = await res.json();
                const u = users.find(user => user.email.toLowerCase() === email.toLowerCase());
                
                // CORREÇÃO: Verifica se o plano no banco de dados é o que foi selecionado
                // Se o banco retornar "OURO", "PRATA" ou "BRONZE" (e não for mais NENHUM)
                if (u && u.plano && u.plano !== "NENHUM") {
                    
                    // 1. Atualiza o texto da tela de sucesso
                    document.getElementById('plano-confirmado').innerText = u.plano;

                    // 2. CONEXÃO MMN: Atualiza a sessão local com o plano REAL do banco
                    // Isso evita que o Dashboard continue lendo "Bronze" se o banco já mudou
                    const localUser = JSON.parse(localStorage.getItem('usuarioLogado') || "{}");
                    localUser.plano = u.plano;
                    localUser.dataExpiracao = u.dataExpiracao;
                    localStorage.setItem('usuarioLogado', JSON.stringify(localUser));

                    if (!u.dataExpiracao) {
                        showStep(3); 
                    } else {
                        clearInterval(checkInterval); // Para o monitoramento
                        setTimeout(() => {
                            window.location.href = `dashboard.html?email=${email}`;
                        }, 2000);
                    }
                }
            } catch (e) {
                console.error("Erro ao monitorar:", e);
            }
        }, 5000);
    }
</script>
</body>
</html>