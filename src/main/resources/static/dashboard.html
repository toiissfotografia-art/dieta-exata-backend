<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL | DIETA EXATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root { 
            --neon: #00f2ff; 
            --bg: #050505; 
            --card: #0d0d0d; 
            --green: #2ecc71; 
            --gold: #ffac00; 
            --text-dim: #888;
        }
        
        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            display: flex; 
            min-height: 100vh; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* Sidebar */
        .sidebar { 
            width: 260px; 
            background: #000; 
            border-right: 1px solid #1a1a1a; 
            padding: 40px 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .logo { 
            font-weight: 800; 
            color: var(--neon); 
            font-size: 18px; 
            text-align: center; 
            margin-bottom: 40px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .nav-link { 
            color: var(--text-dim); 
            text-decoration: none; 
            padding: 14px 18px; 
            border-radius: 12px; 
            transition: 0.3s; 
            font-size: 13px; 
            font-weight: 600;
            cursor: pointer; 
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover, .nav-link.active { 
            background: #111; 
            color: white; 
            box-shadow: inset 4px 0 0 var(--neon);
        }
        
        .logout { 
            margin-top: auto; 
            color: #ff4444; 
            padding-top: 20px;
            border-top: 1px solid #1a1a1a;
            border-radius: 0;
        }

        /* Main Content */
        .main { flex: 1; padding: 40px; overflow-y: auto; background: #080808; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 40px; 
        }
        
        .user-info h2 { 
            margin: 0; 
            font-size: 22px; 
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .plan-badge { 
            background: rgba(0, 242, 255, 0.1); 
            color: var(--neon); 
            padding: 6px 14px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 700; 
            border: 1px solid rgba(0, 242, 255, 0.3);
            display: inline-block;
            margin-top: 8px;
        }

        /* Grid de Cards */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: var(--card); 
            border: 1px solid #1a1a1a; 
            padding: 24px; 
            border-radius: 20px; 
            transition: 0.3s;
        }
        
        .stat-card h4 { 
            margin: 0; 
            color: var(--text-dim); 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            font-weight: 700;
        }
        
        .stat-card .value { 
            font-size: 28px; 
            font-weight: 700; 
            margin: 16px 0 8px 0; 
            color: white; 
        }
        
        .stat-card.balance .value { color: var(--green); }

        /* Seção Dieta e Link */
        .content-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        
        .diet-box { 
            flex: 2; 
            min-width: 320px; 
            background: var(--card); 
            border: 1px solid #1a1a1a; 
            padding: 30px; 
            border-radius: 20px; 
        }
        
        .affiliate-box { 
            flex: 1; 
            min-width: 300px; 
            background: linear-gradient(145deg, #0d0d0d, #161616); 
            border: 1px solid rgba(0, 242, 255, 0.2); 
            padding: 30px; 
            border-radius: 20px; 
        }

        .btn-action { 
            background: var(--neon); 
            color: black; 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 15px; 
            font-size: 13px;
            transition: 0.3s;
        }
        
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 242, 255, 0.2); }

        .copy-link { 
            background: #000; 
            padding: 14px; 
            border: 1px dashed #333; 
            border-radius: 10px; 
            font-size: 12px; 
            word-break: break-all; 
            margin: 15px 0; 
            cursor: pointer; 
            color: var(--neon);
        }

        .transfer-input { 
            background: #000; 
            border: 1px solid #222; 
            color: white; 
            padding: 14px; 
            border-radius: 10px; 
            margin-bottom: 12px; 
            width: 100%; 
            box-sizing: border-box; 
            font-family: 'Inter';
        }
        
        .transfer-input:focus { border-color: var(--neon); outline: none; }

        /* Tabelas */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .data-table th { 
            color: var(--text-dim); 
            text-align: left; 
            padding: 12px; 
            border-bottom: 1px solid #1a1a1a; 
            font-size: 11px; 
            font-weight: 700;
            text-transform: uppercase;
        }
        .data-table td { padding: 14px 12px; border-bottom: 1px solid #111; }

        @media (max-width: 768px) { 
            body { flex-direction: column; } 
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #1a1a1a; padding: 20px; box-sizing: border-box; } 
            .main { padding: 20px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">DIETA EXATA</div>
        <a onclick="showSection('main-dash')" class="nav-link active" id="btn-dash">DASHBOARD</a>
        <a href="configurar-dieta.html" class="nav-link">MINHA DIETA</a>
        <a onclick="showSection('rede-section')" class="nav-link" id="btn-rede">MINHA REDE</a>
        <a onclick="showSection('financeiro-section')" class="nav-link" id="btn-fin">FINANCEIRO</a>
        <a href="upgrade.html" class="nav-link" style="color: var(--gold);">UPGRADE OURO</a>
        <div class="nav-link logout" onclick="logout()">SAIR DO TERMINAL</div>
    </aside>

    <main class="main" id="main-dash">
        <header class="header">
            <div class="user-info">
                <h2 id="user-name">CARREGANDO...</h2>
                <span id="user-plan" class="plan-badge">ATIVANDO...</span>
            </div>
            <div id="system-status" style="font-size: 11px; font-weight: 700; color: var(--green);">● SISTEMA ONLINE</div>
        </header>

        <div class="stats-grid">
            <div class="stat-card balance">
                <h4>Saldo Disponível</h4>
                <div class="value" id="balance">R$ 0,00</div>
                <small style="color: #666; font-size: 11px;">Mínimo para saque: R$ 50,00</small>
            </div>
            <div class="stat-card">
                <h4>Rede Direta</h4>
                <div class="value" id="referrals">0</div>
                <small style="color: #666; font-size: 11px;">Membros ativos (Nível 1)</small>
            </div>
            <div class="stat-card">
                <h4>Ganhos Totais</h4>
                <div class="value" id="total-earnings">R$ 0,00</div>
                <small style="color: #666; font-size: 11px;">Acumulado histórico</small>
            </div>
        </div>

        <div class="content-flex section-toggle" id="content-main">
            <div class="diet-box">
                <h3 style="font-size: 16px; margin-top: 0; font-weight: 700;">PROTOCOLO ATUAL</h3>
                <div id="diet-status">
                    <p style="color: #888; font-size: 14px;">Nenhuma dieta ativa no momento. Inicie a análise por I.A. para gerar seu protocolo.</p>
                    <button class="btn-action" onclick="location.href='configurar-dieta.html'">GERAR MINHA DIETA</button>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #1a1a1a; margin: 30px 0;">
                
                <h3 style="color: var(--neon); font-size: 14px; font-weight: 700; text-transform: uppercase;">Transferência de Saldo</h3>
                <p style="font-size: 12px; color: #888; margin-bottom: 20px;">Envie fundos instantaneamente para outro membro da rede.</p>
                <input type="email" id="transf-email" class="transfer-input" placeholder="E-mail do destinatário">
                <input type="number" id="transf-valor" class="transfer-input" placeholder="Valor (R$)">
                <button class="btn-action" style="background: #111; color: var(--neon); border: 1px solid var(--neon);" onclick="executarTransferencia()">EFETUAR TRANSFERÊNCIA</button>
                
                <button class="btn-action" style="background: #27ae60; color: white; margin-top: 10px;" onclick="window.open('https://wa.me/5511999999999')">SUPORTE NUTRICIONAL</button>
            </div>

            <div class="affiliate-box">
                <h3 style="margin-top: 0; color: var(--neon); font-size: 16px; font-weight: 700;">LINK DE AFILIADO</h3>
                <p style="font-size: 13px; color: #ccc; line-height: 1.5;">Compartilhe seu link e ganhe comissões sobre cada ativação na sua rede.</p>
                <div class="copy-link" id="affiliate-link" onclick="copyLink()">Carregando link...</div>
                <small style="color: #666; font-size: 11px; font-weight: 600;">CLIQUE ACIMA PARA COPIAR</small>
            </div>
        </div>

        <div id="rede-section" class="diet-box section-toggle" style="display: none; margin-top: 0;">
            <h3 style="color: var(--neon); font-size: 16px; font-weight: 700;">MINHA REDE (NÍVEL 1)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>NOME</th>
                        <th>PLANO</th>
                        <th>STATUS</th>
                    </tr>
                </thead>
                <tbody id="rede-lista"></tbody>
            </table>
        </div>

        <div id="financeiro-section" class="diet-box section-toggle" style="display: none; margin-top: 0;">
            <h3 style="color: var(--neon); font-size: 16px; font-weight: 700;">DETALHAMENTO FINANCEIRO</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0;">
                <div style="background: #000; padding: 20px; border-radius: 12px; border: 1px solid #1a1a1a;">
                    <small style="color: #666; text-transform: uppercase; font-weight: 700; font-size: 10px;">Ganhos Diretos</small>
                    <div id="ganho-dir" style="color: var(--green); font-size: 20px; font-weight: 700; margin-top: 5px;">R$ 0,00</div>
                </div>
                <div style="background: #000; padding: 20px; border-radius: 12px; border: 1px solid #1a1a1a;">
                    <small style="color: #666; text-transform: uppercase; font-weight: 700; font-size: 10px;">Ganhos de Rede</small>
                    <div id="ganho-ind" style="color: var(--gold); font-size: 20px; font-weight: 700; margin-top: 5px;">R$ 0,00</div>
                </div>
            </div>
            <p style="font-size: 12px; color: #666; line-height: 1.6;">As comissões são processadas e creditadas instantaneamente em seu saldo após a confirmação do pagamento (PIX) de qualquer membro da sua rede até o 3º nível.</p>
        </div>
    </main>

    <script>
        const sessao = localStorage.getItem('usuarioLogado');
        if (!sessao) window.location.href = 'index.html';
        const user = JSON.parse(sessao);

        function showSection(sectionId) {
            document.querySelectorAll('.section-toggle').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            if (sectionId === 'main-dash') {
                document.getElementById('content-main').style.display = 'flex';
                document.getElementById('btn-dash').classList.add('active');
            } else {
                document.getElementById(sectionId).style.display = 'block';
                if(sectionId === 'rede-section') document.getElementById('btn-rede').classList.add('active');
                if(sectionId === 'financeiro-section') document.getElementById('btn-fin').classList.add('active');
            }
        }

        async function loadDashboardData() {
            try {
                const res = await fetch('api_bridge.php?path=api/usuarios/todos');
                const users = await res.json();
                const currentUser = users.find(u => u.email.toLowerCase() === user.email.toLowerCase());

                if (currentUser) {
                    document.getElementById('user-name').innerText = `OLÁ, ${currentUser.nome.split(' ')[0].toUpperCase()}`;
                    document.getElementById('user-plan').innerText = currentUser.plano || "BRONZE";
                    document.getElementById('balance').innerText = `R$ ${parseFloat(currentUser.saldoDisponivel || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    
                    const ganhosTotais = (currentUser.ganhosDiretos || 0) + (currentUser.ganhosIndiretos || 0);
                    document.getElementById('total-earnings').innerText = `R$ ${ganhosTotais.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    
                    document.getElementById('ganho-dir').innerText = `R$ ${parseFloat(currentUser.ganhosDiretos || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('ganho-ind').innerText = `R$ ${parseFloat(currentUser.ganhosIndiretos || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                    // Lógica MMN: Filtrar indicados diretos
                    const indicados = users.filter(u => u.indicadoPor && u.indicadoPor.toLowerCase() === currentUser.email.toLowerCase());
                    document.getElementById('referrals').innerText = indicados.length;
                    
                    let listaHtml = "";
                    indicados.forEach(i => {
                        listaHtml += `<tr><td>${i.nome}</td><td>${i.plano}</td><td style="color:var(--green); font-weight:700;">ATIVO</td></tr>`;
                    });
                    document.getElementById('rede-lista').innerHTML = listaHtml || "<tr><td colspan='3' style='color:#444; text-align:center;'>Nenhum indicado direto encontrado.</td></tr>";

                    const link = `${window.location.origin}/cadastro.html?ref=${encodeURIComponent(currentUser.email)}`;
                    document.getElementById('affiliate-link').innerText = link;

                    if (currentUser.dietaAtual) {
                        document.getElementById('diet-status').innerHTML = `
                            <p style="color: var(--green); font-size:14px; font-weight:600;">● Protocolo de Biohacking Ativo</p>
                            <button class="btn-action" onclick="location.href='configurar-dieta.html'">VER PROTOCOLO COMPLETO</button>
                        `;
                    }
                    localStorage.setItem('usuarioLogado', JSON.stringify(currentUser));
                }
            } catch (err) { console.error("Erro ao carregar dados:", err); }
        }

        async function executarTransferencia() {
            const emailDest = document.getElementById('transf-email').value.trim();
            const valor = parseFloat(document.getElementById('transf-valor').value);
            const remetente = JSON.parse(localStorage.getItem('usuarioLogado'));
            
            if (!emailDest || isNaN(valor) || valor <= 0) return alert("Preencha os dados corretamente.");
            if (valor > remetente.saldoDisponivel) return alert("Saldo insuficiente.");

            try {
                const res = await fetch('api_bridge.php?path=api/usuarios/transferir', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ emailOrigem: remetente.email, emailDestino: emailDest, valor: valor })
                });
                if (res.ok) { 
                    alert("Transferência realizada com sucesso!"); 
                    loadDashboardData(); 
                    document.getElementById('transf-email').value = "";
                    document.getElementById('transf-valor').value = "";
                } else { 
                    alert("Falha na transferência. Verifique o e-mail do destinatário."); 
                }
            } catch (err) { alert("Erro de conexão com o servidor."); }
        }

        function copyLink() {
            const link = document.getElementById('affiliate-link').innerText;
            navigator.clipboard.writeText(link).then(() => {
                const box = document.getElementById('affiliate-link');
                const originalText = box.innerText;
                box.innerText = "COPIADO COM SUCESSO!";
                setTimeout(() => box.innerText = originalText, 2000);
            });
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        window.onload = loadDashboardData;
    </script>
</body>
</html>