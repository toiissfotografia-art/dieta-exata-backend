<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL | DIETA EXATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        :root { --neon: #00f2ff; --bg: #050505; --card: #0d0d0d; --green: #2ecc71; --gold: #ffac00; }
        body { background: var(--bg); color: white; font-family: 'Rajdhani'; margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Sidebar */
        .sidebar { width: 250px; background: #000; border-right: 1px solid #222; padding: 30px 20px; display: flex; flex-direction: column; gap: 20px; }
        .logo { font-family: 'Orbitron'; color: var(--neon); font-size: 20px; text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px var(--neon); }
        .nav-link { color: #888; text-decoration: none; padding: 12px; border-radius: 5px; transition: 0.3s; font-family: 'Orbitron'; font-size: 13px; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { background: #111; color: white; border-left-color: var(--neon); }
        .logout { margin-top: auto; color: #ff4444; cursor: pointer; }

        /* Main Content */
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .user-info h2 { margin: 0; font-family: 'Orbitron'; font-size: 24px; }
        .plan-badge { background: var(--neon); color: black; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; font-family: 'Orbitron'; }

        /* Grid de Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); border: 1px solid #222; padding: 25px; border-radius: 15px; position: relative; }
        .stat-card h4 { margin: 0; color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-family: 'Orbitron'; font-size: 28px; margin: 15px 0; color: white; }
        .stat-card.balance .value { color: var(--green); }

        /* Seção Dieta e Link */
        .content-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .diet-box { flex: 2; min-width: 300px; background: var(--card); border: 1px solid #222; padding: 30px; border-radius: 15px; }
        .affiliate-box { flex: 1; min-width: 300px; background: linear-gradient(145deg, #0d0d0d, #1a1a1a); border: 1px solid var(--neon); padding: 30px; border-radius: 15px; }

        .btn-action { background: var(--neon); color: black; border: none; padding: 12px 20px; border-radius: 5px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; }
        .copy-link { background: #111; padding: 10px; border: 1px dashed #444; border-radius: 5px; font-size: 12px; word-break: break-all; margin: 10px 0; cursor: pointer; }

        /* Novo Estilo: Campo de Transferência */
        .transfer-input { background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .transfer-input:focus { border-color: var(--neon); outline: none; }

        @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #222; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">DIETA EXATA</div>
        <a href="dashboard.html" class="nav-link active">DASHBOARD</a>
        <a href="configurar-dieta.html" class="nav-link">MINHA DIETA</a>
        <a href="rede.html" class="nav-link">MINHA REDE</a>
        <a href="financeiro.html" class="nav-link">FINANCEIRO</a>
        <a href="upgrade.html" class="nav-link" style="color: var(--gold);">UPGRADE OURO</a>
        <div class="nav-link logout" onclick="logout()">SAIR DO TERMINAL</div>
    </aside>

    <main class="main">
        <header class="header">
            <div class="user-info">
                <h2 id="user-name">Carregando...</h2>
                <span id="user-plan" class="plan-badge">ATIVANDO...</span>
            </div>
            <div id="system-status" style="font-size: 12px; color: var(--green);">SISTEMA ONLINE</div>
        </header>

        <div class="stats-grid">
            <div class="stat-card balance">
                <h4>Saldo Disponível</h4>
                <div class="value" id="balance">R$ 0,00</div>
                <small style="color: #666;">Próximo saque: R$ 50,00 min.</small>
            </div>
            <div class="stat-card">
                <h4>Rede Direta</h4>
                <div class="value" id="referrals">0</div>
                <small style="color: #666;">Membros ativos no Nível 1</small>
            </div>
            <div class="stat-card">
                <h4>Ganhos Totais</h4>
                <div class="value" id="total-earnings">R$ 0,00</div>
            </div>
        </div>

        <div class="content-flex">
            <div class="diet-box">
                <h3 style="font-family: 'Orbitron'; margin-top: 0;">PROTOCOLO ATUAL</h3>
                <div id="diet-status">
                    <p style="color: #888;">Nenhuma dieta ativa no momento. Inicie a análise por I.A. para gerar seu protocolo de nutrição.</p>
                    <button class="btn-action" onclick="location.href='configurar-dieta.html'">GERAR MINHA DIETA</button>
                </div>
                
                <hr style="border: 0; border-top: 1px solid #222; margin: 30px 0;">
                
                <h3 style="font-family: 'Orbitron'; color: var(--neon); font-size: 16px;">TRANSFERÊNCIA DE SALDO</h3>
                <p style="font-size: 12px; color: #888;">Envie fundos instantaneamente para outro membro.</p>
                <input type="email" id="transf-email" class="transfer-input" placeholder="E-mail do destinatário">
                <input type="number" id="transf-valor" class="transfer-input" placeholder="Valor (R$)">
                <button class="btn-action" style="background: #1a1a1a; color: var(--neon); border: 1px solid var(--neon);" onclick="executarTransferencia()">EFETUAR TRANSFERÊNCIA</button>
            </div>

            <div class="affiliate-box">
                <h3 style="font-family: 'Orbitron'; margin-top: 0; color: var(--neon);">LINK DE AFILIADO</h3>
                <p style="font-size: 14px; color: #ccc;">Compartilhe seu link e ganhe comissões sobre cada upgrade na sua rede.</p>
                <div class="copy-link" id="affiliate-link" onclick="copyLink()">
                    Carregando link...
                </div>
                <small style="color: #666;">Clique no box acima para copiar</small>
            </div>
        </div>
    </main>

    <script>
        // Verificação de Sessão
        const sessao = localStorage.getItem('usuarioLogado');
        if (!sessao) window.location.href = 'index.html';

        const user = JSON.parse(sessao);

        // --- ATUALIZAÇÃO DE DADOS EM TEMPO REAL ---
        async function loadDashboardData() {
            try {
                const res = await fetch('api_bridge.php?path=api/usuarios/todos');
                const users = await res.json();
                const currentUser = users.find(u => u.email.toLowerCase() === user.email.toLowerCase());

                if (currentUser) {
                    document.getElementById('user-name').innerText = `OLÁ, ${currentUser.nome.split(' ')[0]}`;
                    document.getElementById('user-plan').innerText = currentUser.plano || "BRONZE";
                    document.getElementById('balance').innerText = `R$ ${parseFloat(currentUser.saldoDisponivel || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('total-earnings').innerText = `R$ ${parseFloat(currentUser.saldoTotal || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    
                    const indicados = users.filter(u => u.indicadorEmail && u.indicadorEmail.toLowerCase() === currentUser.email.toLowerCase());
                    document.getElementById('referrals').innerText = indicados.length;

                    // LINK CORRIGIDO: Agora usa o domínio e o parâmetro ref
                    const link = `${window.location.origin}/planos.html?ref=${currentUser.email}`;
                    document.getElementById('affiliate-link').innerText = link;

                    if (currentUser.dietaAtual) {
                        document.getElementById('diet-status').innerHTML = `
                            <p style="color: var(--green);">● Protocolo de Biohacking Ativo</p>
                            <p style="font-size: 14px; color: #ccc;">Sua dieta personalizada está pronta para consulta.</p>
                            <button class="btn-action" onclick="location.href='configurar-dieta.html'">VER PROTOCOLO</button>
                        `;
                    }
                    localStorage.setItem('usuarioLogado', JSON.stringify(currentUser));
                }
            } catch (err) {
                console.error("Erro ao carregar dados do Dashboard:", err);
            }
        }

        // --- INCLUSÃO: LÓGICA DE TRANSFERÊNCIA ---
        async function executarTransferencia() {
    const emailDest = document.getElementById('transf-email').value.trim();
    const valor = parseFloat(document.getElementById('transf-valor').value);
    const remetente = JSON.parse(localStorage.getItem('usuarioLogado'));

    if (!emailDest || isNaN(valor) || valor <= 0) {
        alert("Preencha o e-mail e um valor válido.");
        return;
    }

    try {
        const res = await fetch('api_bridge.php?path=api/usuarios/transferir', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                emailOrigem: remetente.email, // Ajustado para bater com o Java
                emailDestino: emailDest,       // Ajustado para bater com o Java
                valor: valor
            })
        });

        if (res.ok) {
            alert("Transferência realizada!");
            loadDashboardData();
        } else {
            const erroMsg = await res.text();
            alert("Erro: " + erroMsg);
        }
    } catch (err) {
        alert("Erro ao conectar com o servidor.");
    }
}

        function copyLink() {
            const link = document.getElementById('affiliate-link').innerText;
            navigator.clipboard.writeText(link).then(() => {
                alert("Link de indicação copiado!");
            });
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        window.onload = loadDashboardData;
    </script>
</body>
</html>